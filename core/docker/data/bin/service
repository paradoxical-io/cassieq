#!/usr/bin/env bash

conf_dir=/data/conf

libs_dir=/data/lib

configFile=$conf_dir/configuration.yml

function run_app(){

    classname="io.paradoxical.cassieq.ServiceApplication"

    command=$1

    for jar in ${libs_dir}/*.jar; do
        classpath=$classpath:$jar
    done

    properties="-Djava.library.path=${libs_dir} "

    properties="${properties} -Dcom.sun.management.jmxremote.rmi.port=1898"
    properties="${properties} -Dcom.sun.management.jmxremote.port=1898"
    properties="${properties} -Dcom.sun.management.jmxremote.ssl=false"
    properties="${properties} -Dcom.sun.management.jmxremote.authenticate=false"
    properties="${properties} -Djava.rmi.server.hostname=${HOST_IPADDR}"

    if [ "${DEBUG_JAVA}" == "true" ]; then
        properties="$properties -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=1044"
    fi

    echo "USING JAVA DEBUG $properties"

    cmd="java $properties -cp $classpath $classname $command"

    echo ${cmd}

    exec ${cmd}
}

function boostrap(){
    java -jar /data/tools/cassandra-loader.jar \
        -k ${KEYSPACE} \
        -ip ${CONTACT_POINTS} \
        -u ${USERNAME} \
        -pw ${PASSWORD} \
        -f /data/db \
        "$@"
}

case "$1" in
    "bootstrap")
        shift
        bootstrap $@;;

    "debug")
        shift
        exec /bin/bash;;

    "default-config")
        run_app "config -a $configFile";;

    *)
        run_app "server $configFile";;
esac
